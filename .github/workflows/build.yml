name: Build and Test Mach MK42 Kernel

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      actions: write  # For artifact upload
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build Docker image with QEMU
      run: |
        echo "Building Docker image with build tools and QEMU..."
        docker build -t mach-mk42-builder .
        
    - name: Run complete test suite
      run: |
        echo "Running build and boot test in Docker..."
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          mach-mk42-builder \
          /workspace/scripts/test-all.sh
          
    - name: Extract kernel binary
      run: |
        echo "Extracting kernel binary for artifacts..."
        mkdir -p artifacts
        
        # Find and copy kernel binary
        if [ -f "obj/i386_mach/latest/kernel/STD+WS/mach_kernel" ]; then
          cp obj/i386_mach/latest/kernel/STD+WS/mach_kernel artifacts/
          echo "Kernel binary copied to artifacts/"
        elif [ -f "mach_kernel.MK42.STD+WS" ]; then
          cp mach_kernel.MK42.STD+WS artifacts/mach_kernel
          echo "Pre-built kernel copied to artifacts/"
        fi
        
        # Create kernel info file
        if [ -f "artifacts/mach_kernel" ]; then
          echo "=== Mach MK42 Kernel Build ===" > artifacts/kernel-info.txt
          echo "Build Date: $(date)" >> artifacts/kernel-info.txt
          echo "Git Commit: ${{ github.sha }}" >> artifacts/kernel-info.txt
          echo "" >> artifacts/kernel-info.txt
          file artifacts/mach_kernel >> artifacts/kernel-info.txt
          ls -lh artifacts/mach_kernel >> artifacts/kernel-info.txt
        fi
          
    - name: Upload kernel artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: mach-kernel-${{ github.sha }}
        path: |
          artifacts/
        if-no-files-found: warn
        retention-days: 30

  qemu-boot-test:
    needs: build-and-test
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      actions: read  # For artifact download
    
    env:
      QEMU_TIMEOUT: 30  # Timeout in seconds for QEMU boot test
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install QEMU
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-system-x86
        
    - name: Download kernel artifact
      uses: actions/download-artifact@v4
      with:
        name: mach-kernel-${{ github.sha }}
        path: artifacts/
        
    - name: Display kernel information
      run: |
        echo "=== Kernel binary information ==="
        if [ -f "artifacts/mach_kernel" ]; then
          file artifacts/mach_kernel
          ls -lh artifacts/mach_kernel
          
          if [ -f "artifacts/kernel-info.txt" ]; then
            echo ""
            echo "=== Build Information ==="
            cat artifacts/kernel-info.txt
          fi
        else
          echo "No kernel binary found in artifacts!"
          ls -la artifacts/
          exit 1
        fi
        
    - name: Boot kernel in QEMU (i386)
      run: |
        echo "=== Booting Mach MK42 kernel in QEMU i386 ==="
        echo "Note: Mach is a microkernel and requires user-space servers to fully boot."
        echo "This test validates that the kernel loads via GRUB and begins execution."
        echo ""
        
        KERNEL="artifacts/mach_kernel"
        
        if [ ! -f "$KERNEL" ]; then
          echo "Error: Kernel not found at $KERNEL"
          exit 1
        fi
        
        # Check kernel format
        echo "Kernel format:"
        file "$KERNEL"
        echo ""
        
        # Create bootable ISO with GRUB for proper booting
        if file "$KERNEL" | grep -q "a.out"; then
          echo "Creating bootable ISO (a.out format requires GRUB bootloader)..."
          
          # Install GRUB tools
          sudo apt-get install -y grub-pc-bin xorriso mtools
          
          # Create ISO structure
          mkdir -p iso_build/boot/grub
          cp "$KERNEL" iso_build/boot/mach_kernel
          
          # Create GRUB config
          cat > iso_build/boot/grub/grub.cfg << 'EOF'
        set timeout=3
        set default=0
        menuentry "Mach MK42" {
          multiboot /boot/mach_kernel
          boot
        }
        EOF
          
          # Create ISO
          grub-mkrescue -o mach-mk42.iso iso_build 2>&1 | grep -v "DOS partition" || true
          echo "ISO created successfully"
          
          # Boot from ISO
          timeout ${QEMU_TIMEOUT}s qemu-system-i386 \
            -cdrom mach-mk42.iso \
            -m 64M \
            -nographic \
            -no-reboot || EXIT_CODE=$?
        else
          # Direct kernel boot for other formats
          timeout ${QEMU_TIMEOUT}s qemu-system-i386 \
            -kernel "$KERNEL" \
            -nographic \
            -m 64M \
            -no-reboot || EXIT_CODE=$?
        fi
        
        # Exit code 124 means timeout (expected for kernel without user-space)
        # Exit code 0 means clean exit
        if [ "${EXIT_CODE:-0}" -eq 124 ]; then
          echo ""
          echo "=== QEMU Boot Test: SUCCESS ==="
          echo "✓ Kernel loaded via GRUB and attempted to boot (timeout is expected)"
          echo "✓ This validates the kernel binary is loadable and begins execution"
          exit 0
        elif [ "${EXIT_CODE:-0}" -eq 0 ]; then
          echo ""
          echo "=== QEMU Boot Test: SUCCESS ==="
          echo "✓ Kernel exited cleanly"
          exit 0
        else
          echo ""
          echo "=== QEMU Boot Test: FAILED ==="
          echo "✗ QEMU failed with exit code ${EXIT_CODE}"
          echo "This may indicate a problem with the kernel binary"
          exit ${EXIT_CODE}
        fi
